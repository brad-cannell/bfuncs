<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Brad Cannell" />


<title>Frequency Tables</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Frequency Tables</h1>
<h4 class="author"><em>Brad Cannell</em></h4>
<h4 class="date"><em>Created: 2017-11-10 <br> Updated: 2017-11-17</em></h4>



<p>I initially created this file to help develop the freq_table function in <code>bfuncs</code>. Use this file for testing as you further develop the <code>freq_table</code> function (or any other functions related to categorical frequency tables). Additionally, as you come across different use cases or challenges, add them to this document.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">data</span>(mtcars)</code></pre></div>
<ol style="list-style-type: decimal">
<li><p>Remember, fist get it to work. Then, make it better.</p></li>
<li><p>Let’s just take for granted that we are going to get a grouped dataframe. That’s easy enough to implement in R.</p></li>
</ol>
<p>Useful websites:</p>
<p><a href="https://support.sas.com/documentation/cdl/en/statug/63347/HTML/default/viewer.htm#statug_surveyfreq_a0000000221.htm" class="uri">https://support.sas.com/documentation/cdl/en/statug/63347/HTML/default/viewer.htm#statug_surveyfreq_a0000000221.htm</a></p>
<p><a href="https://support.sas.com/documentation/cdl/en/statug/63347/HTML/default/viewer.htm#statug_surveyfreq_a0000000217.htm" class="uri">https://support.sas.com/documentation/cdl/en/statug/63347/HTML/default/viewer.htm#statug_surveyfreq_a0000000217.htm</a></p>
<div id="one-way-frequency-tables" class="section level1">
<h1>One-way frequency tables</h1>
<p>With Wald (SAS) CI’s</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(am) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">cumsum =</span> <span class="kw">sum</span>(n),
    <span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span>cumsum,
    <span class="dt">se =</span> <span class="kw">sqrt</span>(prop <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop) <span class="op">/</span><span class="st"> </span>(cumsum <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)),
    <span class="dt">tcrit =</span> stats<span class="op">::</span><span class="kw">qt</span>(<span class="fl">0.975</span>, <span class="dt">df =</span> cumsum <span class="op">-</span><span class="st"> </span><span class="dv">1</span>),
    <span class="dt">lower =</span> prop <span class="op">-</span><span class="st"> </span>tcrit <span class="op">*</span><span class="st"> </span>se,
    <span class="dt">upper =</span> prop <span class="op">+</span><span class="st"> </span>tcrit <span class="op">*</span><span class="st"> </span>se
  )</code></pre></div>
<pre><code># A tibble: 2 x 8
     am     n cumsum    prop         se    tcrit     lower     upper
  &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;   &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1     0    19     32 0.59375 0.08820997 2.039513 0.4138446 0.7736554
2     1    13     32 0.40625 0.08820997 2.039513 0.2263446 0.5861554</code></pre>
<p>Double-checked with Stata and SAS. The se should be n-1 and the df should be n-1. These confindence limits match SAS exactly.</p>
<p>Using logit transformed confidence intervals like Stata. <a href="https://www.stata.com/manuals13/rproportion.pdf" class="uri">https://www.stata.com/manuals13/rproportion.pdf</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(am) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(
      <span class="dt">cumsum    =</span> <span class="kw">sum</span>(n),
      <span class="dt">prop      =</span> n <span class="op">/</span><span class="st"> </span>cumsum,
      <span class="dt">log_prop  =</span> <span class="kw">log</span>(prop) <span class="op">-</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop),
      <span class="dt">se        =</span> <span class="kw">sqrt</span>(prop <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop) <span class="op">/</span><span class="st"> </span>(cumsum <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)),
      <span class="dt">log_se    =</span> se <span class="op">/</span><span class="st"> </span>(prop <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop)),
      <span class="dt">t_crit    =</span> stats<span class="op">::</span><span class="kw">qt</span>(<span class="fl">0.975</span>, <span class="dt">df =</span> cumsum <span class="op">-</span><span class="st"> </span><span class="dv">1</span>),
      <span class="dt">log_lower =</span> log_prop <span class="op">-</span><span class="st"> </span>t_crit <span class="op">*</span><span class="st"> </span>log_se,
      <span class="dt">log_upper =</span> log_prop <span class="op">+</span><span class="st"> </span>t_crit <span class="op">*</span><span class="st"> </span>log_se,
      <span class="dt">lower     =</span> <span class="kw">exp</span>(log_lower) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(log_lower)),
      <span class="dt">upper     =</span> <span class="kw">exp</span>(log_upper) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(log_upper))
    ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(<span class="dv">1</span>, n, prop, se, lower, upper)</code></pre></div>
<pre><code># A tibble: 2 x 6
     am     n    prop         se     lower     upper
  &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1     0    19 0.59375 0.08820997 0.4094225 0.7549765
2     1    13 0.40625 0.08820997 0.2450235 0.5905775</code></pre>
<p>This matches Stata exactly.</p>
</div>
<div id="two-way-frequency-tables" class="section level1">
<h1>Two-way frequency tables</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(am, cyl) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">cumsum =</span> <span class="kw">sum</span>(n),
    <span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span>cumsum,
    <span class="dt">percent =</span> prop <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
    <span class="dt">se =</span> <span class="kw">sqrt</span>(prop <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop) <span class="op">/</span><span class="st"> </span>(cumsum)),
    <span class="dt">sep =</span> se <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
    <span class="dt">tcrit =</span> stats<span class="op">::</span><span class="kw">qt</span>(<span class="fl">0.975</span>, <span class="dt">df =</span> cumsum),
    <span class="dt">lower =</span> prop <span class="op">-</span><span class="st"> </span>tcrit <span class="op">*</span><span class="st"> </span>se,
    <span class="dt">upper =</span> prop <span class="op">+</span><span class="st"> </span>tcrit <span class="op">*</span><span class="st"> </span>se
  ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, percent, sep, lower, upper)</code></pre></div>
<pre><code># A tibble: 6 x 8
# Groups:   am [2]
     am   cyl     n cumsum  percent       sep       lower     upper
  &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;
1     0     4     3     19 15.78947  8.365468 -0.01719651 0.3329860
2     0     6     4     19 21.05263  9.352877  0.01476835 0.4062843
3     0     8    12     19 63.15789 11.066473  0.39995500 0.8632029
4     1     4     8     13 61.53846 13.493200  0.32388175 0.9068875
5     1     6     3     13 23.07692 11.685454 -0.02167966 0.4832181
6     1     8     2     13 15.38462 10.006825 -0.06233816 0.3700305</code></pre>
<p>These don’t match SAS. The Standard errors are off. The SAS documentation says they use the Taylor series variance estimation method.</p>
<p><a href="https://support.sas.com/documentation/cdl/en/statug/63347/HTML/default/viewer.htm#statug_surveyfreq_a0000000217.htm" class="uri">https://support.sas.com/documentation/cdl/en/statug/63347/HTML/default/viewer.htm#statug_surveyfreq_a0000000217.htm</a></p>
<p>I don’t know how to calculate that. Seeing if I can reproduce Stata results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(am, cyl) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group_n =</span> <span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">total_n   =</span> <span class="kw">sum</span>(n),
    <span class="dt">prop      =</span> n <span class="op">/</span><span class="st"> </span>group_n,
    <span class="dt">log_prop  =</span> <span class="kw">log</span>(prop) <span class="op">-</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop),
    <span class="dt">se        =</span> <span class="kw">sqrt</span>(prop <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop) <span class="op">/</span><span class="st"> </span>(group_n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)), <span class="co"># group n - 1</span>
    <span class="dt">log_se    =</span> se <span class="op">/</span><span class="st"> </span>(prop <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop)),
    <span class="dt">t_crit    =</span> stats<span class="op">::</span><span class="kw">qt</span>(<span class="fl">0.975</span>, <span class="dt">df =</span> total_n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>), <span class="co"># overall n - 1</span>
    <span class="dt">log_lower =</span> log_prop <span class="op">-</span><span class="st"> </span>t_crit <span class="op">*</span><span class="st"> </span>log_se,
    <span class="dt">log_upper =</span> log_prop <span class="op">+</span><span class="st"> </span>t_crit <span class="op">*</span><span class="st"> </span>log_se,
    <span class="dt">lower     =</span> <span class="kw">exp</span>(log_lower) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(log_lower)),
    <span class="dt">upper     =</span> <span class="kw">exp</span>(log_upper) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(log_upper))
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, n, group_n, total_n, prop, se, lower, upper)  </code></pre></div>
<pre><code># A tibble: 6 x 9
     am   cyl     n group_n total_n      prop         se      lower
  &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;   &lt;int&gt;   &lt;int&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
1     0     4     3      19      32 0.1578947 0.08594701 0.04777477
2     0     6     4      19      32 0.2105263 0.09609168 0.07579485
3     0     8    12      19      32 0.6315789 0.11369721 0.38756354
4     1     4     8      13      32 0.6153846 0.14044168 0.32296598
5     1     6     3      13      32 0.2307692 0.12162606 0.06905055
6     1     8     2      13      32 0.1538462 0.10415434 0.03433831
# ... with 1 more variables: upper &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="co"># map_at(.at = c(5:8), ~ . * 100) %&gt;% </span>
  <span class="co"># as_tibble()</span></code></pre></div>
<p>Exact same results as Stata.</p>
<p>Write function. Given a grouped tibble, automatically return the stats above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">freq_table &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">t_prob =</span> <span class="fl">0.975</span>, <span class="dt">ci_type =</span> <span class="st">&quot;log&quot;</span>, ...) {
  
  <span class="co"># ===========================================================================</span>
  <span class="co"># Check for grouped tibble</span>
  <span class="co"># ===========================================================================</span>
  <span class="cf">if</span> (<span class="op">!</span>(<span class="st">&quot;grouped_df&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">class</span>(x))) {
    <span class="kw">stop</span>(<span class="kw">paste</span>(<span class="st">&quot;The x argument to freq_table must be a grouped tibble. </span>
<span class="st">               The class of the current x argument is&quot;</span>, <span class="kw">class</span>(x)))
  } <span class="co"># No else</span>
  
  <span class="co"># ===========================================================================</span>
  <span class="co"># Check for number of group vars: </span>
  <span class="co"># If 1 var then use Wald and overall prop</span>
  <span class="co"># If 2 vars then use logit transformation for CI's and give row prop in</span>
  <span class="co"># addition to overall.</span>
  <span class="co"># ===========================================================================</span>
  out &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>())
  
  <span class="co"># ===========================================================================</span>
  <span class="co"># One-way tables</span>
  <span class="co"># ===========================================================================</span>
  <span class="cf">if</span> (<span class="kw">ncol</span>(out) <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) { <span class="co"># else is in two-way tables.</span>
    
    <span class="co"># Update out to include elements need for Wald and Log transformed CI's</span>
    <span class="co"># One-way tables</span>
    out &lt;-<span class="st"> </span>out <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(
        <span class="dt">n_total =</span> <span class="kw">sum</span>(n),
        <span class="dt">prop    =</span> n <span class="op">/</span><span class="st"> </span>n_total,
        <span class="dt">se      =</span> <span class="kw">sqrt</span>(prop <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop) <span class="op">/</span><span class="st"> </span>(n_total <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)),
        <span class="dt">t_crit  =</span> stats<span class="op">::</span><span class="kw">qt</span>(t_prob, <span class="dt">df =</span> n_total <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)
      )
        
        <span class="co"># Calculate Wald CI's</span>
        <span class="co"># and put prop, se, and CI's on percent scale</span>
        <span class="co"># One-way tables</span>
        <span class="cf">if</span> (ci_type <span class="op">==</span><span class="st"> &quot;wald&quot;</span>) {
          
          out &lt;-<span class="st"> </span>out <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">            </span><span class="kw">mutate</span>(
              <span class="dt">lcl_wald =</span> prop <span class="op">-</span><span class="st"> </span>t_crit <span class="op">*</span><span class="st"> </span>se,
              <span class="dt">ucl_wald =</span> prop <span class="op">+</span><span class="st"> </span>t_crit <span class="op">*</span><span class="st"> </span>se,
              <span class="dt">percent  =</span> prop <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
              <span class="dt">se       =</span> se <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, 
              <span class="dt">lcl_wald =</span> lcl_wald <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
              <span class="dt">ucl_wald =</span> ucl_wald <span class="op">*</span><span class="st"> </span><span class="dv">100</span>
            ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">            </span>
<span class="st">            </span><span class="co"># Control output</span>
<span class="st">            </span><span class="kw">select</span>(<span class="dv">1</span>, n, n_total, percent, se, t_crit, lcl_wald, ucl_wald)
        
        <span class="co"># Calculate log transformed CI's</span>
        <span class="co"># and put prop, se, and CI's on percent scale</span>
        <span class="co"># One-way tables</span>
        } <span class="cf">else</span> <span class="cf">if</span> (ci_type <span class="op">==</span><span class="st"> &quot;log&quot;</span>) {
          
          out &lt;-<span class="st"> </span>out <span class="op">%&gt;%</span>
<span class="st">            </span><span class="kw">mutate</span>(
              <span class="dt">prop_log =</span> <span class="kw">log</span>(prop) <span class="op">-</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop),
              <span class="dt">se_log   =</span> se <span class="op">/</span><span class="st"> </span>(prop <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop)),
              <span class="dt">lcl_log  =</span> prop_log <span class="op">-</span><span class="st"> </span>t_crit <span class="op">*</span><span class="st"> </span>se_log,
              <span class="dt">ucl_log  =</span> prop_log <span class="op">+</span><span class="st"> </span>t_crit <span class="op">*</span><span class="st"> </span>se_log,
              <span class="dt">lcl_log  =</span> <span class="kw">exp</span>(lcl_log) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(lcl_log)),
              <span class="dt">ucl_log  =</span> <span class="kw">exp</span>(ucl_log) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(ucl_log)),
              <span class="dt">percent  =</span> prop <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
              <span class="dt">se       =</span> se <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, 
              <span class="dt">lcl_log  =</span> lcl_log <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
              <span class="dt">ucl_log  =</span> ucl_log <span class="op">*</span><span class="st"> </span><span class="dv">100</span> 
            ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span>
<span class="st">            </span><span class="co"># Control output</span>
<span class="st">            </span><span class="kw">select</span>(<span class="dv">1</span>, n, n_total, percent, se, t_crit, lcl_log, ucl_log)
        }


  <span class="co"># =========================================================================== </span>
  <span class="co"># Two-way tables</span>
  <span class="co"># Only logged transformed CI's</span>
  <span class="co"># Need percent and row percent</span>
  <span class="co"># ===========================================================================</span>
  } <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">ncol</span>(out) <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) { <span class="co"># if is one-way tables</span>
    
    out &lt;-<span class="st"> </span>out <span class="op">%&gt;%</span>
<span class="st">      </span><span class="co"># Calculate within row n</span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">n_group =</span> <span class="kw">sum</span>(n)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="co"># Ungroup to get total_n</span>
<span class="st">      </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate</span>(
        
        <span class="co"># Estimate overall percent se and CI's</span>
        <span class="dt">n_total        =</span> <span class="kw">sum</span>(n),
        <span class="dt">prop_total     =</span> n <span class="op">/</span><span class="st"> </span>n_total,
        <span class="dt">se_total       =</span> <span class="kw">sqrt</span>(prop_total <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop_total) <span class="op">/</span><span class="st"> </span>(n_total <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)),
        <span class="dt">t_crit_total   =</span> stats<span class="op">::</span><span class="kw">qt</span>(t_prob, <span class="dt">df =</span> n_total <span class="op">-</span><span class="st"> </span><span class="dv">1</span>),
        <span class="dt">prop_log_total =</span> <span class="kw">log</span>(prop_total) <span class="op">-</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop_total),
        <span class="dt">se_log_total   =</span> se_total <span class="op">/</span><span class="st"> </span>(prop_total <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop_total)),
        <span class="dt">lcl_total_log  =</span> prop_log_total <span class="op">-</span><span class="st"> </span>t_crit_total <span class="op">*</span><span class="st"> </span>se_log_total,
        <span class="dt">ucl_total_log  =</span> prop_log_total <span class="op">+</span><span class="st"> </span>t_crit_total <span class="op">*</span><span class="st"> </span>se_log_total,
        <span class="dt">lcl_total_log  =</span> <span class="kw">exp</span>(lcl_total_log) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(lcl_total_log)),
        <span class="dt">ucl_total_log  =</span> <span class="kw">exp</span>(ucl_total_log) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(ucl_total_log)),
        <span class="dt">percent_total  =</span> prop_total <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
        <span class="dt">se_total       =</span> se_total <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, 
        <span class="dt">lcl_total_log  =</span> lcl_total_log <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
        <span class="dt">ucl_total_log  =</span> ucl_total_log <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
        
        
        <span class="co"># Estimate row percent se and CI's</span>
        <span class="dt">prop_row     =</span> n <span class="op">/</span><span class="st"> </span>n_group,
        <span class="dt">se_row       =</span> <span class="kw">sqrt</span>(prop_row <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop_row) <span class="op">/</span><span class="st"> </span>(n_group <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)), <span class="co"># group n - 1</span>
        <span class="dt">t_crit_row   =</span> stats<span class="op">::</span><span class="kw">qt</span>(t_prob, <span class="dt">df =</span> n_total <span class="op">-</span><span class="st"> </span><span class="dv">1</span>), <span class="co"># overall n - 1</span>
        <span class="dt">prop_log_row =</span> <span class="kw">log</span>(prop_row) <span class="op">-</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop_row),
        <span class="dt">se_log_row   =</span> se_row <span class="op">/</span><span class="st"> </span>(prop_row <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>prop_row)),
        <span class="dt">lcl_row_log  =</span> prop_log_row <span class="op">-</span><span class="st"> </span>t_crit_row <span class="op">*</span><span class="st"> </span>se_log_row,
        <span class="dt">ucl_row_log  =</span> prop_log_row <span class="op">+</span><span class="st"> </span>t_crit_row <span class="op">*</span><span class="st"> </span>se_log_row,
        <span class="dt">lcl_row_log  =</span> <span class="kw">exp</span>(lcl_row_log) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(lcl_row_log)),
        <span class="dt">ucl_row_log  =</span> <span class="kw">exp</span>(ucl_row_log) <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(ucl_row_log)),
        <span class="dt">percent_row  =</span> prop_row <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
        <span class="dt">se_row       =</span> se_row <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, 
        <span class="dt">lcl_row_log  =</span> lcl_row_log <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,
        <span class="dt">ucl_row_log  =</span> ucl_row_log <span class="op">*</span><span class="st"> </span><span class="dv">100</span>
      ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span>
<span class="st">      </span><span class="co"># Control output</span>
<span class="st">      </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, n, n_group, n_total, percent_total, se_total, lcl_total_log, 
             ucl_total_log, percent_row, se_row, lcl_row_log, ucl_row_log)
    
  } <span class="cf">else</span> { <span class="co"># Grouped by more than two variables, or not grouped.</span>
    <span class="kw">stop</span>(
      <span class="kw">paste</span>(
        <span class="st">&quot;Expecting x to be a grouped data frame with 2 or 3 columns. Instead</span>
<span class="st">        x had&quot;</span>, <span class="kw">ncol</span>(out) 
      )
    )
  }
  
  <span class="co"># Return tibble of results</span>
  out
}</code></pre></div>
<p>Test one_table</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(am) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">freq_table</span>()</code></pre></div>
<pre><code># A tibble: 2 x 8
     am     n n_total percent       se   t_crit  lcl_log  ucl_log
  &lt;dbl&gt; &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1     0    19      32  59.375 8.820997 2.039513 40.94225 75.49765
2     1    13      32  40.625 8.820997 2.039513 24.50235 59.05775</code></pre>
<p>Test two-way tables</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(am, cyl) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">freq_table</span>()</code></pre></div>
<pre><code># A tibble: 6 x 13
     am   cyl     n n_group n_total percent_total se_total lcl_total_log
  &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;   &lt;int&gt;   &lt;int&gt;         &lt;dbl&gt;    &lt;dbl&gt;         &lt;dbl&gt;
1     0     4     3      19      32         9.375 5.235146      2.859820
2     0     6     4      19      32        12.500 5.939887      4.506576
3     0     8    12      19      32        37.500 8.695104     21.969117
4     1     4     8      13      32        25.000 7.777138     12.514741
5     1     6     3      13      32         9.375 5.235146      2.859820
6     1     8     2      13      32         6.250 4.347552      1.446671
# ... with 5 more variables: ucl_total_log &lt;dbl&gt;, percent_row &lt;dbl&gt;,
#   se_row &lt;dbl&gt;, lcl_row_log &lt;dbl&gt;, ucl_row_log &lt;dbl&gt;</code></pre>
<p>Data checks:<br />
* One-way Wald matches SAS.<br />
* One-way log transformed matches Stata.<br />
* Two-way log transformed matches Stata.<br />
* Need to see if I can get someone in biostats to help me code the Taylor series.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
